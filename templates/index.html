<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Actionable Insight Overview</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body>
    <div class="container">
      <h1>Actionable Insight Overview</h1>

      <!-- User Filter -->
      <div class="filter-container">
        <div class="filter-group">
          <label for="user-filter-btn" class="filter-label">Filter by User:</label>
          <button id="user-filter-btn" class="filter-button">
            <span id="selected-count">All Users</span>
            <span class="filter-arrow">▼</span>
          </button>

          <div
            id="user-filter-dropdown"
            class="filter-dropdown"
            style="display: none">
            <div class="filter-search">
              <input type="text" id="user-search" placeholder="Search users..." />
            </div>
            <div class="filter-actions">
              <button id="select-all-btn" class="action-btn">Select All</button>
              <button id="clear-all-btn" class="action-btn">Clear All</button>
            </div>
            <div class="filter-options" id="user-options">
              {% for user in all_users %}
              <label class="filter-option">
                <input
                  type="checkbox"
                  class="user-checkbox"
                  value="{{ user }}"
                  checked />
                <span>{{ user }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="filter-footer">
              <button id="apply-filter-btn" class="apply-btn">Apply</button>
            </div>
          </div>
        </div>

        <div class="filter-group">
          <label for="campaign-filter-btn" class="filter-label">Campaign Type:</label>
          <button id="campaign-filter-btn" class="filter-button">
            <span id="campaign-selected-count">All Campaigns</span>
            <span class="filter-arrow">▼</span>
          </button>

          <div
            id="campaign-filter-dropdown"
            class="filter-dropdown"
            style="display: none">
            <div class="filter-search">
              <input type="text" id="campaign-search" placeholder="Search campaigns..." />
            </div>
            <div class="filter-actions">
              <button id="campaign-select-all-btn" class="action-btn">Select All</button>
              <button id="campaign-clear-all-btn" class="action-btn">Clear All</button>
            </div>
            <div class="filter-options" id="campaign-options">
              {% for campaign in all_campaign_types %}
              <label class="filter-option">
                <input
                  type="checkbox"
                  class="campaign-checkbox"
                  value="{{ campaign }}"
                  checked />
                <span>{{ campaign }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="filter-footer">
              <button id="campaign-apply-filter-btn" class="apply-btn">Apply</button>
            </div>
          </div>
        </div>
      </div>

      <div class="pivot-table-container">
        <table class="pivot-table">
          <thead>
            <tr>
              <th class="action-header">Action Type</th>
              {% for phase in phase_order %}
              <th class="phase-header">{{ phase }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for action in all_actions %}
            <tr>
              <td class="action-cell">{{ action }}</td>
              {% for phase in phase_order %}
              <td class="pivot-cell">
                {% if pivot_data[action][phase] %} {% for issue in
                pivot_data[action][phase] %}
                <div
                  class="issue-item"
                  onclick="showFindings('{{ action|escape }}', '{{ issue.Issue|escape }}')">
                  <span class="issue-text">{{ issue.Issue_Clean }}</span>
                  <span class="issue-badge">{{ issue.Finding_Count }}</span>
                </div>
                {% endfor %} {% else %}
                <span class="empty-cell">—</span>
                {% endif %}
              </td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Modal hiển thị Finding Detail -->
    <div id="finding-modal" class="modal" style="display: none">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3 id="modal-issue-title"></h3>
        <div class="table-container">
          <table id="modal-finding-table">
            <thead>
              <tr>
                <th>Finding</th>
                <th>User</th>
                <th>Phase</th>
                <th>Issue Explanation</th>
                <th>Action Explanation</th>
                <th>Action Confidence</th>
                <th>Campaign Type</th>
                <th>Reference</th>
              </tr>
            </thead>
            <tbody>
              <!-- Nội dung sẽ được thêm bằng JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      let detailMap = {{ detail_map|tojson }};
      let pivotData = {{ pivot_data|tojson }};
      let phaseOrder = {{ phase_order|tojson }};
      let allActions = {{ all_actions|tojson }};
      let allUsersList = {{ all_users|tojson }};
      let allCampaignTypesList = {{ all_campaign_types|tojson }};
      let selectedUsers = new Set(allUsersList);
      let selectedCampaignTypes = new Set(allCampaignTypesList);

      function toggleDropdown(buttonId, dropdownId) {
          const dropdown = document.getElementById(dropdownId);
          dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
          document.getElementById(buttonId).classList.toggle('active');
      }

      function closeDropdown(dropdownId, buttonId) {
          const dropdown = document.getElementById(dropdownId);
          dropdown.style.display = 'none';
          document.getElementById(buttonId).classList.remove('active');
      }

      document.getElementById('user-filter-btn').addEventListener('click', function(e) {
          e.stopPropagation();
          toggleDropdown('user-filter-btn', 'user-filter-dropdown');
      });

      document.getElementById('campaign-filter-btn').addEventListener('click', function(e) {
          e.stopPropagation();
          toggleDropdown('campaign-filter-btn', 'campaign-filter-dropdown');
      });

      // Close dropdowns when clicking outside
      document.addEventListener('click', function(e) {
          [['user-filter-dropdown', 'user-filter-btn'], ['campaign-filter-dropdown', 'campaign-filter-btn']].forEach(ids => {
              const [dropdownId, buttonId] = ids;
              const dropdown = document.getElementById(dropdownId);
              const button = document.getElementById(buttonId);
              if (!dropdown.contains(e.target) && e.target !== button && !button.contains(e.target)) {
                  closeDropdown(dropdownId, buttonId);
              }
          });
      });

      // Prevent dropdown close when clicking inside
      ['user-filter-dropdown', 'campaign-filter-dropdown'].forEach(id => {
          document.getElementById(id).addEventListener('click', function(e) {
              e.stopPropagation();
          });
      });

      // Search functionality
      document.getElementById('user-search').addEventListener('input', function(e) {
          const searchTerm = e.target.value.toLowerCase();
          document.querySelectorAll('#user-options .filter-option').forEach(option => {
              const text = option.textContent.toLowerCase();
              option.style.display = text.includes(searchTerm) ? 'flex' : 'none';
          });
      });

      document.getElementById('campaign-search').addEventListener('input', function(e) {
          const searchTerm = e.target.value.toLowerCase();
          document.querySelectorAll('#campaign-options .filter-option').forEach(option => {
              const text = option.textContent.toLowerCase();
              option.style.display = text.includes(searchTerm) ? 'flex' : 'none';
          });
      });

      // Select All / Clear All for users
      document.getElementById('select-all-btn').addEventListener('click', function() {
          document.querySelectorAll('.user-checkbox').forEach(cb => {
              if (cb.parentElement.style.display !== 'none') {
                  cb.checked = true;
              }
          });
      });

      document.getElementById('clear-all-btn').addEventListener('click', function() {
          document.querySelectorAll('.user-checkbox').forEach(cb => {
              if (cb.parentElement.style.display !== 'none') {
                  cb.checked = false;
              }
          });
      });

      // Select All / Clear All for campaigns
      document.getElementById('campaign-select-all-btn').addEventListener('click', function() {
          document.querySelectorAll('.campaign-checkbox').forEach(cb => {
              if (cb.parentElement.style.display !== 'none') {
                  cb.checked = true;
              }
          });
      });

      document.getElementById('campaign-clear-all-btn').addEventListener('click', function() {
          document.querySelectorAll('.campaign-checkbox').forEach(cb => {
              if (cb.parentElement.style.display !== 'none') {
                  cb.checked = false;
              }
          });
      });

      // Apply Filters
      function applyUserSelection() {
          selectedUsers.clear();
          document.querySelectorAll('.user-checkbox:checked').forEach(cb => {
              selectedUsers.add(cb.value);
          });
          updateUserSelectedCount();
          closeDropdown('user-filter-dropdown', 'user-filter-btn');
          applyFilter();
      }

      function applyCampaignSelection() {
          selectedCampaignTypes.clear();
          document.querySelectorAll('.campaign-checkbox:checked').forEach(cb => {
              selectedCampaignTypes.add(cb.value);
          });
          updateCampaignSelectedCount();
          closeDropdown('campaign-filter-dropdown', 'campaign-filter-btn');
          applyFilter();
      }

      document.getElementById('apply-filter-btn').addEventListener('click', applyUserSelection);
      document.getElementById('campaign-apply-filter-btn').addEventListener('click', applyCampaignSelection);

      function updateUserSelectedCount() {
          const count = selectedUsers.size;
          const total = allUsersList.length;
          const label = count === total ? 'All Users' : `${count} of ${total} selected`;
          document.getElementById('selected-count').textContent = label;
      }

      function updateCampaignSelectedCount() {
          const count = selectedCampaignTypes.size;
          const total = allCampaignTypesList.length;
          const label = count === total ? 'All Campaigns' : `${count} of ${total} selected`;
          document.getElementById('campaign-selected-count').textContent = label;
      }

      updateUserSelectedCount();
      updateCampaignSelectedCount();

      async function applyFilter() {
          const users = Array.from(selectedUsers);
          const campaigns = Array.from(selectedCampaignTypes);
          // If all are selected, pass empty array to show all data
          const usersToSend = users.length === allUsersList.length ? [] : users;
          const campaignsToSend = campaigns.length === allCampaignTypesList.length ? [] : campaigns;

          try {
              const response = await fetch('/api/filter', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      users: usersToSend,
                      campaign_types: campaignsToSend
                  })
              });

              const data = await response.json();
              pivotData = data.pivot_data;
              phaseOrder = data.phase_order;
              allActions = data.all_actions;
              detailMap = data.detail_map;

              rebuildTable();
          } catch (error) {
              console.error('Error filtering data:', error);
          }
      }

      function rebuildTable() {
          const tbody = document.querySelector('.pivot-table tbody');
          tbody.innerHTML = '';

          allActions.forEach(action => {
              const tr = document.createElement('tr');

              // Action cell
              const actionCell = document.createElement('td');
              actionCell.className = 'action-cell';
              actionCell.textContent = action;
              tr.appendChild(actionCell);

              // Phase cells
              phaseOrder.forEach(phase => {
                  const phaseCell = document.createElement('td');
                  phaseCell.className = 'pivot-cell';

                  const issues = pivotData[action][phase] || [];

                  if (issues.length > 0) {
                      issues.forEach(issue => {
                          const issueDiv = document.createElement('div');
                          issueDiv.className = 'issue-item';
                          issueDiv.onclick = () => showFindings(action, issue.Issue);

                          const issueText = document.createElement('span');
                          issueText.className = 'issue-text';
                          issueText.textContent = issue.Issue_Clean;

                          const issueBadge = document.createElement('span');
                          issueBadge.className = 'issue-badge';
                          issueBadge.textContent = issue.Finding_Count;

                          issueDiv.appendChild(issueText);
                          issueDiv.appendChild(issueBadge);
                          phaseCell.appendChild(issueDiv);
                      });
                  } else {
                      const emptySpan = document.createElement('span');
                      emptySpan.className = 'empty-cell';
                      emptySpan.textContent = '—';
                      phaseCell.appendChild(emptySpan);
                  }

                  tr.appendChild(phaseCell);
              });

              tbody.appendChild(tr);
          });
      }

      function showFindings(action, issue) {
          const key = action + '|||' + issue;
          let details = detailMap[key] || [];

          // Filter by selected users
          if (selectedUsers.size > 0) {
              details = details.filter(obj => selectedUsers.has(obj.user));
          }
          // Filter by selected campaign types if available in detail map
          if (selectedCampaignTypes.size > 0) {
              details = details.filter(obj => selectedCampaignTypes.has(obj.campaign_type));
          }

          document.getElementById('modal-issue-title').innerText = action + ' → ' + issue;
          const tbody = document.getElementById('modal-finding-table').querySelector('tbody');
          tbody.innerHTML = '';

          details.forEach(obj => {
              const tr = document.createElement('tr');

              const tdFinding = document.createElement('td');
              tdFinding.innerText = obj.finding || '';

              const tdUser = document.createElement('td');
              tdUser.innerText = obj.user || '';

              const tdPhase = document.createElement('td');
              tdPhase.innerText = obj.phase || '';

              const tdIssueExplanation = document.createElement('td');
              tdIssueExplanation.innerText = obj.issue_explanation || '';

              const tdActionExplanation = document.createElement('td');
              tdActionExplanation.innerText = obj.action_explanation || '';

              const tdConfidence = document.createElement('td');
              tdConfidence.innerText = obj.action_confidence || '';

              const tdCampaign = document.createElement('td');
              tdCampaign.innerText = obj.campaign_type || '';

              const tdReference = document.createElement('td');
              const ref = obj.reference || '';
              if (ref) {
                  if (ref.startsWith('/')) {
                      const fullUrl = `https://2h.momo.vn${ref}`;
                      const button = document.createElement('a');
                      button.href = fullUrl;
                      button.target = '_blank';
                      button.rel = 'noopener noreferrer';
                      button.textContent = 'View material';
                      button.className = 'material-btn';
                      tdReference.appendChild(button);
                  } else {
                      const link = document.createElement('a');
                      link.href = ref;
                      link.target = '_blank';
                      link.rel = 'noopener noreferrer';
                      link.textContent = ref;
                      tdReference.appendChild(link);
                  }
              } else {
                  tdReference.innerText = '';
              }

              tr.appendChild(tdFinding);
              tr.appendChild(tdUser);
              tr.appendChild(tdPhase);
              tr.appendChild(tdIssueExplanation);
              tr.appendChild(tdActionExplanation);
              tr.appendChild(tdConfidence);
              tr.appendChild(tdCampaign);
              tr.appendChild(tdReference);
              tbody.appendChild(tr);
          });

          document.getElementById('finding-modal').style.display = 'flex';
      }

      function closeModal() {
          document.getElementById('finding-modal').style.display = 'none';
      }
    </script>
    <style>
      .modal {
        position: fixed;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      .modal-content {
        background: #fff;
        padding: 30px;
        border-radius: 10px;
        min-width: 1200px;
        width: 90vw;
        max-width: 95vw;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
        max-height: 80vh;
        overflow: auto;
      }
      .table-container {
        max-height: 55vh;
        overflow-y: auto;
        margin-top: 20px;
      }
      #modal-finding-table {
        width: 100%;
        border-collapse: collapse;
      }
      #modal-finding-table th,
      #modal-finding-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
        vertical-align: top;
      }
      #modal-finding-table th {
        background: #f2f2f2;
        position: sticky;
        top: 0;
      }
      .close {
        float: right;
        font-size: 2em;
        cursor: pointer;
        margin-top: -10px;
      }
    </style>
  </body>
</html>
