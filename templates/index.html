<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Actionable Insight Overview</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body>
    <div class="container">
      <h1>Actionable Insight Overview</h1>

      <div class="filters">
        <!-- User Filter -->
        <div class="filter-container">
          <label for="user-filter-btn" class="filter-label">User</label>
          <button id="user-filter-btn" class="filter-button">
            <span id="selected-count">All Users</span>
            <span class="filter-arrow">▼</span>
          </button>

          <div
            id="user-filter-dropdown"
            class="filter-dropdown"
            style="display: none">
            <div class="filter-search">
              <input
                type="text"
                id="user-search"
                placeholder="Search users..." />
            </div>
            <div class="filter-actions">
              <button id="select-all-btn" class="action-btn">Select All</button>
              <button id="clear-all-btn" class="action-btn">Clear All</button>
            </div>
            <div class="filter-options" id="user-options">
              {% for user in all_users %}
              <label class="filter-option">
                <input
                  type="checkbox"
                  class="user-checkbox"
                  value="{{ user }}"
                  checked />
                <span>{{ user }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="filter-footer">
              <button id="apply-filter-btn" class="apply-btn">Apply</button>
            </div>
          </div>
        </div>

        <!-- Campaign Type Filter -->
        <div class="filter-container">
          <label for="campaign-filter-btn" class="filter-label"
            >Campaign Type</label
          >
          <button id="campaign-filter-btn" class="filter-button">
            <span id="selected-campaign-count">All Campaign Types</span>
            <span class="filter-arrow">▼</span>
          </button>

          <div
            id="campaign-filter-dropdown"
            class="filter-dropdown"
            style="display: none">
            <div class="filter-search">
              <input
                type="text"
                id="campaign-search"
                placeholder="Search campaign types..." />
            </div>
            <div class="filter-actions">
              <button id="select-all-campaign-btn" class="action-btn">
                Select All
              </button>
              <button id="clear-all-campaign-btn" class="action-btn">
                Clear All
              </button>
            </div>
            <div class="filter-options" id="campaign-options">
              {% for campaign_type in all_campaign_types %}
              <label class="filter-option">
                <input
                  type="checkbox"
                  class="campaign-checkbox"
                  value="{{ campaign_type }}"
                  checked />
                <span>{{ campaign_type }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="filter-footer">
              <button id="apply-campaign-filter-btn" class="apply-btn">
                Apply
              </button>
            </div>
          </div>
        </div>

        <!-- User Segment Filter -->
        <div class="filter-container">
          <label for="segment-filter-btn" class="filter-label"
            >User Segment</label
          >
          <button id="segment-filter-btn" class="filter-button">
            <span id="selected-segment-count">All Segments</span>
            <span class="filter-arrow">▼</span>
          </button>

          <div
            id="segment-filter-dropdown"
            class="filter-dropdown"
            style="display: none">
            <div class="filter-search">
              <input
                type="text"
                id="segment-search"
                placeholder="Search user segments..." />
            </div>
            <div class="filter-actions">
              <button id="select-all-segment-btn" class="action-btn">
                Select All
              </button>
              <button id="clear-all-segment-btn" class="action-btn">
                Clear All
              </button>
            </div>
            <div class="filter-options" id="segment-options">
              {% for segment in all_segments %}
              <label class="filter-option">
                <input
                  type="checkbox"
                  class="segment-checkbox"
                  value="{{ segment }}"
                  checked />
                <span>{{ segment }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="filter-footer">
              <button id="apply-segment-filter-btn" class="apply-btn">
                Apply
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="pivot-table-container">
        <table class="pivot-table">
          <thead>
            <tr>
              <th class="action-header">Action Type</th>
              {% for phase in phase_order %}
              <th class="phase-header">{{ phase }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for action in all_actions %}
            <tr>
              <td class="action-cell">{{ action }}</td>
              {% for phase in phase_order %}
              <td class="pivot-cell">
                {% if pivot_data[action][phase] %} {% for issue in
                pivot_data[action][phase] %}
                <div
                  class="issue-item"
                  onclick="showFindings('{{ action|escape }}', '{{ issue.Issue|escape }}')">
                  <span class="issue-text">{{ issue.Issue_Clean }}</span>
                  <span class="issue-badge">{{ issue.Finding_Count }}</span>
                </div>
                {% endfor %} {% else %}
                <span class="empty-cell">—</span>
                {% endif %}
              </td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Modal hiển thị Finding Detail -->
    <div id="finding-modal" class="modal" style="display: none">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3 id="modal-issue-title"></h3>
        <div class="table-container">
          <table id="modal-finding-table">
            <thead>
              <tr>
                <th>Finding</th>
                <th>Campaign Type</th>
                <th>User Segment</th>
                <th>User</th>
                <th>Phase</th>
                <th>Issue Explanation</th>
                <th>Action Explanation</th>
                <th>Action Confidence</th>
                <th>Reference</th>
              </tr>
            </thead>
            <tbody>
              <!-- Nội dung sẽ được thêm bằng JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      let detailMap = {{ detail_map|tojson }};
      let pivotData = {{ pivot_data|tojson }};
      let phaseOrder = {{ phase_order|tojson }};
      let allActions = {{ all_actions|tojson }};
      let selectedUsers = new Set({{ all_users|tojson }});
      let selectedCampaignTypes = new Set({{ all_campaign_types|tojson }});
      let selectedSegments = new Set({{ all_segments|tojson }});

      // Filter dropdown toggle
      document.getElementById('user-filter-btn').addEventListener('click', function(e) {
          e.stopPropagation();
          const dropdown = document.getElementById('user-filter-dropdown');
          dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
      });

      document.getElementById('campaign-filter-btn').addEventListener('click', function(e) {
          e.stopPropagation();
          const dropdown = document.getElementById('campaign-filter-dropdown');
          dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
      });

      document.getElementById('segment-filter-btn').addEventListener('click', function(e) {
          e.stopPropagation();
          const dropdown = document.getElementById('segment-filter-dropdown');
          dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', function(e) {
          const userDropdown = document.getElementById('user-filter-dropdown');
          const userButton = document.getElementById('user-filter-btn');
          const campaignDropdown = document.getElementById('campaign-filter-dropdown');
          const campaignButton = document.getElementById('campaign-filter-btn');
          const segmentDropdown = document.getElementById('segment-filter-dropdown');
          const segmentButton = document.getElementById('segment-filter-btn');

          if (!userDropdown.contains(e.target) && e.target !== userButton) {
              userDropdown.style.display = 'none';
          }

          if (!campaignDropdown.contains(e.target) && e.target !== campaignButton) {
              campaignDropdown.style.display = 'none';
          }

          if (!segmentDropdown.contains(e.target) && e.target !== segmentButton) {
              segmentDropdown.style.display = 'none';
          }
      });

      // Prevent dropdown close when clicking inside
      document.getElementById('user-filter-dropdown').addEventListener('click', function(e) {
          e.stopPropagation();
      });

      document.getElementById('campaign-filter-dropdown').addEventListener('click', function(e) {
          e.stopPropagation();
      });

      document.getElementById('segment-filter-dropdown').addEventListener('click', function(e) {
          e.stopPropagation();
      });

      // Search functionality
      document.getElementById('user-search').addEventListener('input', function(e) {
          const searchTerm = e.target.value.toLowerCase();
          document.querySelectorAll('#user-options .filter-option').forEach(option => {
              const text = option.textContent.toLowerCase();
              option.style.display = text.includes(searchTerm) ? 'flex' : 'none';
          });
      });

      document.getElementById('campaign-search').addEventListener('input', function(e) {
          const searchTerm = e.target.value.toLowerCase();
          document.querySelectorAll('#campaign-options .filter-option').forEach(option => {
              const text = option.textContent.toLowerCase();
              option.style.display = text.includes(searchTerm) ? 'flex' : 'none';
          });
      });

      document.getElementById('segment-search').addEventListener('input', function(e) {
          const searchTerm = e.target.value.toLowerCase();
          document.querySelectorAll('#segment-options .filter-option').forEach(option => {
              const text = option.textContent.toLowerCase();
              option.style.display = text.includes(searchTerm) ? 'flex' : 'none';
          });
      });

      // Select All
      document.getElementById('select-all-btn').addEventListener('click', function() {
          document.querySelectorAll('.user-checkbox').forEach(cb => {
              if (cb.parentElement.style.display !== 'none') {
                  cb.checked = true;
              }
          });
      });

      // Clear All
      document.getElementById('clear-all-btn').addEventListener('click', function() {
          document.querySelectorAll('.user-checkbox').forEach(cb => {
              if (cb.parentElement.style.display !== 'none') {
                  cb.checked = false;
              }
          });
      });

      document.getElementById('select-all-campaign-btn').addEventListener('click', function() {
          document.querySelectorAll('.campaign-checkbox').forEach(cb => {
              if (cb.parentElement.style.display !== 'none') {
                  cb.checked = true;
              }
          });
      });

      document.getElementById('clear-all-campaign-btn').addEventListener('click', function() {
          document.querySelectorAll('.campaign-checkbox').forEach(cb => {
              if (cb.parentElement.style.display !== 'none') {
                  cb.checked = false;
              }
          });
      });

      document.getElementById('select-all-segment-btn').addEventListener('click', function() {
          document.querySelectorAll('.segment-checkbox').forEach(cb => {
              if (cb.parentElement.style.display !== 'none') {
                  cb.checked = true;
              }
          });
      });

      document.getElementById('clear-all-segment-btn').addEventListener('click', function() {
          document.querySelectorAll('.segment-checkbox').forEach(cb => {
              if (cb.parentElement.style.display !== 'none') {
                  cb.checked = false;
              }
          });
      });

      // Apply Filter
      document.getElementById('apply-filter-btn').addEventListener('click', function() {
          selectedUsers.clear();
          document.querySelectorAll('.user-checkbox:checked').forEach(cb => {
              selectedUsers.add(cb.value);
          });
          updateSelectedCount();
          applyFilter();
          document.getElementById('user-filter-dropdown').style.display = 'none';
      });

      document.getElementById('apply-campaign-filter-btn').addEventListener('click', function() {
          selectedCampaignTypes.clear();
          document.querySelectorAll('.campaign-checkbox:checked').forEach(cb => {
              selectedCampaignTypes.add(cb.value);
          });
          updateSelectedCampaignCount();
          applyFilter();
          document.getElementById('campaign-filter-dropdown').style.display = 'none';
      });

      document.getElementById('apply-segment-filter-btn').addEventListener('click', function() {
          selectedSegments.clear();
          document.querySelectorAll('.segment-checkbox:checked').forEach(cb => {
              selectedSegments.add(cb.value);
          });
          updateSelectedSegmentCount();
          applyFilter();
          document.getElementById('segment-filter-dropdown').style.display = 'none';
      });

      function updateSelectedCount() {
          const count = selectedUsers.size;
          const total = {{ all_users|length }};
          const label = count === total ? 'All Users' : `${count} of ${total} selected`;
          document.getElementById('selected-count').textContent = label;
      }

      function updateSelectedCampaignCount() {
          const count = selectedCampaignTypes.size;
          const total = {{ all_campaign_types|length }};
          const label = count === total ? 'All Campaign Types' : `${count} of ${total} selected`;
          document.getElementById('selected-campaign-count').textContent = label;
      }

      function updateSelectedSegmentCount() {
          const count = selectedSegments.size;
          const total = {{ all_segments|length }};
          const label = count === total ? 'All Segments' : `${count} of ${total} selected`;
          document.getElementById('selected-segment-count').textContent = label;
      }

      async function applyFilter() {
          const users = Array.from(selectedUsers);
          const campaignTypes = Array.from(selectedCampaignTypes);
          const segments = Array.from(selectedSegments);
          const allUsersList = {{ all_users|tojson }};
          const allCampaignTypes = {{ all_campaign_types|tojson }};
          const allSegments = {{ all_segments|tojson }};

          // If all users are selected, pass empty array to show all data
          const usersToSend = users.length === allUsersList.length ? [] : users;
          const campaignTypesToSend = campaignTypes.length === allCampaignTypes.length ? [] : campaignTypes;
          const segmentsToSend = segments.length === allSegments.length ? [] : segments;

          try {
              const response = await fetch('/api/filter', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      users: usersToSend,
                      campaign_types: campaignTypesToSend,
                      segments: segmentsToSend
                  })
              });

              const data = await response.json();
              pivotData = data.pivot_data;
              phaseOrder = data.phase_order;
              allActions = data.all_actions;
              detailMap = data.detail_map;

              rebuildTable();
          } catch (error) {
              console.error('Error filtering data:', error);
          }
      }

      function rebuildTable() {
          const tbody = document.querySelector('.pivot-table tbody');
          tbody.innerHTML = '';

          allActions.forEach(action => {
              const tr = document.createElement('tr');
              // Action cell
              const actionCell = document.createElement('td');
              actionCell.className = 'action-cell';
              actionCell.textContent = action;
              tr.appendChild(actionCell);

              // Phase cells
              phaseOrder.forEach(phase => {
                  const phaseCell = document.createElement('td');
                  phaseCell.className = 'pivot-cell';

                  const issues = pivotData[action][phase] || [];

                  if (issues.length > 0) {
                      issues.forEach(issue => {
                          const issueDiv = document.createElement('div');
                          issueDiv.className = 'issue-item';
                          issueDiv.onclick = () => showFindings(action, issue.Issue);

                          const issueText = document.createElement('span');
                          issueText.className = 'issue-text';
                          issueText.textContent = issue.Issue_Clean;

                          const issueBadge = document.createElement('span');
                          issueBadge.className = 'issue-badge';
                          issueBadge.textContent = issue.Finding_Count;

                          issueDiv.appendChild(issueText);
                          issueDiv.appendChild(issueBadge);
                          phaseCell.appendChild(issueDiv);
                      });
                  } else {
                      const emptySpan = document.createElement('span');
                      emptySpan.className = 'empty-cell';
                      emptySpan.textContent = '—';
                      phaseCell.appendChild(emptySpan);
                  }

                  tr.appendChild(phaseCell);
              });

              tbody.appendChild(tr);
          });
          return true;
      }

      function showFindings(action, issue) {
          const key = action + '|||' + issue;
          let details = detailMap[key] || [];

          // Filter by selected users, campaign types, and user segments
          if (selectedUsers.size > 0) {
              details = details.filter(obj => selectedUsers.has(obj.user));
          }
          if (selectedCampaignTypes.size > 0) {
              details = details.filter(obj => selectedCampaignTypes.has(obj.campaign_type));
          }
          if (selectedSegments.size > 0) {
              details = details.filter(obj => selectedSegments.has(obj.user_segment));
          }

          document.getElementById('modal-issue-title').innerText = action + ' → ' + issue;
          const tbody = document.getElementById('modal-finding-table').querySelector('tbody');
          tbody.innerHTML = '';

          details.forEach(obj => {
              const tr = document.createElement('tr');

              const tdFinding = document.createElement('td');
              tdFinding.innerText = obj.finding || '';

              const tdCampaignType = document.createElement('td');
              tdCampaignType.innerText = obj.campaign_type || '';

              const tdUserSegment = document.createElement('td');
              tdUserSegment.innerText = obj.user_segment || '';

              const tdUser = document.createElement('td');
              tdUser.innerText = obj.user || '';

              const tdPhase = document.createElement('td');
              tdPhase.innerText = obj.phase || '';

              const tdIssueExplanation = document.createElement('td');
              tdIssueExplanation.innerText = obj.issue_explanation || '';

              const tdActionExplanation = document.createElement('td');
              tdActionExplanation.innerText = obj.action_explanation || '';

              const tdConfidence = document.createElement('td');
              tdConfidence.innerText = obj.action_confidence || '';

              const tdReference = document.createElement('td');
              const ref = obj.reference || '';
              if (ref.startsWith('/uploads')) {
                      const fullUrl = `https://2h.momo.vn${ref}`;
                      const button = document.createElement('a');
                      button.href = fullUrl;
                      button.target = '_blank';
                      button.rel = 'noopener noreferrer';
                      button.textContent = 'View material';
                      button.className = 'material-btn';
                      tdReference.appendChild(button);
              }
              else {
                  tdReference.innerText = "None";
              }

              tr.appendChild(tdFinding);
              tr.appendChild(tdCampaignType);
              tr.appendChild(tdUserSegment);
              tr.appendChild(tdUser);
              tr.appendChild(tdPhase);
              tr.appendChild(tdIssueExplanation);
              tr.appendChild(tdActionExplanation);
              tr.appendChild(tdConfidence);
              tr.appendChild(tdReference);
              tbody.appendChild(tr);
          });

          document.getElementById('finding-modal').style.display = 'flex';
      }

      function closeModal() {
          document.getElementById('finding-modal').style.display = 'none';
      }

      // Initialize counters on load
      updateSelectedCount();
      updateSelectedCampaignCount();
      updateSelectedSegmentCount();
    </script>
    <style>
      .modal {
        position: fixed;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      .modal-content {
        background: #fff;
        padding: 30px;
        border-radius: 10px;
        min-width: 1200px;
        width: 90vw;
        max-width: 95vw;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
        max-height: 80vh;
        overflow: auto;
      }
      .table-container {
        max-height: 55vh;
        overflow-y: auto;
        margin-top: 20px;
      }
      #modal-finding-table {
        width: 100%;
        border-collapse: collapse;
      }
      #modal-finding-table th,
      #modal-finding-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
        vertical-align: top;
      }
      #modal-finding-table th {
        background: #f2f2f2;
        position: sticky;
        top: 0;
      }
      .close {
        float: right;
        font-size: 2em;
        cursor: pointer;
        margin-top: -10px;
      }
    </style>
  </body>
</html>
